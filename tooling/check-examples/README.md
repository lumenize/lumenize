# @lumenize/docusaurus-plugin-check-examples

A Docusaurus plugin that verifies code examples in hand-written `.mdx` files match actual test code.

## Problem

Documentation examples drift from actual code over time:
- Functions get renamed (e.g., `getDOStubFromPathname` → `getDOStub`)
- APIs change but docs aren't updated
- Examples work initially but break silently

## Solution

Annotate code blocks to verify they exist in passing tests. Annotations go on the fence line (invisible to readers):

```mdx
```typescript @check-example('packages/utils/test/route-do-request.test.ts')
import { routeDORequest } from '@lumenize/utils';

const response = await routeDORequest(env.MY_DO, request);
\```
```

The plugin will:
1. Extract the code from your documentation
2. Read the referenced test file
3. Normalize both (strip comments/whitespace)
4. Verify the doc code exists as a substring in the test file
5. Fail the build with helpful errors if not found

## Usage

### 1. Install

```bash
npm install --save-dev @lumenize/docusaurus-plugin-check-examples
```

### 2. Add to docusaurus.config.ts

```typescript
export default {
  plugins: [
    '@lumenize/docusaurus-plugin-check-examples',
  ],
};
```

### 3. Annotate code blocks

Add `@check-example(path)` to the opening fence line of code blocks you want to verify:

```mdx
```typescript @check-example('packages/utils/test/route-do-request.test.ts')
const response = await routeDORequest(env.MY_DO, request);
\```
```

You can also put it as a comment on the first line of the code block (for backward compatibility):

```mdx
```typescript
// @check-example('packages/utils/test/route-do-request.test.ts')
const response = await routeDORequest(env.MY_DO, request);
\```
```

### 4. Skip verification when needed

For examples that shouldn't be verified (e.g., npm install commands), add `@skip-check` to the fence line:

```mdx
```bash npm2yarn @skip-check
npm install @lumenize/rpc
\```
```

## Design Decisions

### Normalized Matching (Default)
- TypeScript/JavaScript: Strips comments and normalizes whitespace
- Allows minor formatting differences between docs and tests
- Doc code must exist as substring in test file

### Strict Matching (Opt-in)
```mdx
```python
# @check-example('test/example.py', { strict: true })
def hello():
    return "world"
\```
```

### Why Substring Matching?
- Tests are comprehensive, docs show focused snippets
- Doc examples are extracted from larger test contexts
- More resilient than line-number-based matching (tests change frequently)

### Phase 1 Scope
- **Supported:** TypeScript, JavaScript (with normalization)
- **Other languages:** Require `strict: true` for exact matching
- **Future:** Smart matching (const/let/var equivalence, etc.)

## How It Works

1. **Build-time scanning:** Plugin runs during Docusaurus build
2. **Parse .mdx files:** Extract annotated code blocks
3. **Normalize code:** Strip comments, collapse whitespace (TypeScript/JS only)
4. **Substring search:** Check if doc code exists in test file
5. **Clear errors:** Show file, line, expected code, helpful suggestions

## Integration with doc-testing

This plugin is complementary to `@lumenize/docusaurus-plugin-doc-testing`:

- **doc-testing**: Generates comprehensive API docs by executing tests
- **check-examples**: Verifies hand-written snippet examples match tests

Files generated by doc-testing are automatically skipped (they have `generated_by: doc-testing` in frontmatter).

## Error Messages

When verification fails:

```
❌ Example verification failed in website/docs/utils/route-do-request.mdx:42

Expected code not found in packages/utils/test/route-do-request.test.ts:
  const response = await getDOStubFromPathname(env.MY_DO, request);

Possible issues:
- Function renamed? Check test file for similar patterns
- API changed? Update example to match current implementation
- Test file moved? Update @check-example path
```

## Performance

- Caches test file contents during build (only if easy to implement)
- Target: <5 seconds for all website docs
- Runs only on .mdx files with annotations (minimal overhead)

## License

MIT
