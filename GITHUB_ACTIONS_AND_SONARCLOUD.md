# GitHub Actions and SonarCloud Configuration

This repository is configured for continuous integration via GitHub Actions and SonarCloud code quality analysis with support for pull request (PR) analysis and code coverage reporting.

## Configuration Overview

- **Excluded from analysis**: `lumenize-monolith/` directory
- **Excluded from coverage**: All `*.test.ts` files
- **Coverage format**: LCOV (generated by vitest with istanbul)
- **PR analysis**: Configured for delta analysis between PR branches and `main`

## Setup

### 1. SonarCloud Project Setup

1. Create a SonarCloud account at https://sonarcloud.io
2. Create a new project for this repository
3. Note:
   - Organization key: 'lumenize'
   - Project Key: 'lumenize_lumenize'
4. Generate a **SonarCloud Token** (User > My Account > Security)

### 2. Update Configuration

Edit `sonar-project.properties` and set:
- `sonar.organization=your-organization-key`
- `sonar.projectKey=your-project-key`

## IDE Plugin

The SonarQube/SonarLint plugin in your IDE provides:
- **Real-time code analysis** as you type
- **Local issue detection** (bugs, code smells, security vulnerabilities)
- **Quick fixes** for many issues
- **Connected mode** (optional) - syncs rules with SonarCloud for consistency

**Note**: The IDE plugin does **NOT** upload results to SonarCloud. It's purely for local development feedback. All SonarCloud analysis happens via GitHub Actions.

## GitHub Actions Integration

SonarCloud analysis runs automatically on pull requests via GitHub Actions. See `.github/workflows/ci.yml` for the workflow configuration.

**Required GitHub Secrets**:
- `SONAR_TOKEN`: Your SonarCloud authentication token

GitHub automatically provides a short-lived `GITHUB_TOKEN` to workflows, so you do **not** need to create a separate secret for it.

The workflow (`ci.yml`) includes the following jobs:

1. **`run-packages-tests-with-coverage`**: Runs tests with coverage for all packages in `packages/` directory
2. **`run-doc-tests`**: Runs tests (without coverage) for all doc-test examples in `doc-test/*/*/` subdirectories
3. **`sonarcloud-analysis`**: Only runs if both test jobs pass:
   - Uploads code and coverage reports to SonarCloud
   - SonarCloud performs analysis server-side (no CLI runs locally)
   - Automatically detects PR context and sets PR analysis parameters
   - Posts analysis results as PR comments

**Note**: Doc-test examples run without coverage to avoid cluttering coverage reports with example code. Coverage reports focus on the actual packages in `packages/`.

## Coverage Report Locations

Coverage reports are generated in each package's `coverage/` directory:
- `packages/*/coverage/lcov.info` - Individual package coverage files

SonarCloud is configured to read coverage from packages only (tooling, website, and experiments are excluded from coverage reporting). The SonarCloud GitHub Action automatically aggregates coverage from multiple files when analyzing PRs.

## Exclusions

### Source Code Exclusions (from all analysis)
- `lumenize-monolith/**` - Excluded from all analysis
- `doc-test/**` - Documentation test examples
- `examples/**` - Example code
- `experiments/**` - Experimental code
- `website/**` - Website source (excluded from all analysis)
- `node_modules/**` - Dependencies
- `dist/**` - Build outputs
- `coverage/**` - Coverage reports

**Note**: `tooling/` is included in source analysis (quality/security) but excluded from coverage reporting.

### Coverage Exclusions
- `**/*.test.ts` - All test files excluded from coverage metrics
- `tooling/**` - Tooling packages excluded from coverage
- `experiments/**` - Experimental code excluded from coverage
- `website/**` - Website source excluded from coverage

## Troubleshooting

### No coverage reports found
- Ensure tests are run with coverage: `npm run test:code`
- Check that vitest configs include `'lcov'` in the `reporter` array
- Verify `coverage/` directories exist in packages after running tests

### Authentication errors
- Verify your `SONAR_TOKEN` is correct
- Check token hasn't expired (regenerate if needed)
- Ensure token has permissions for your organization/project

### Coverage not appearing in SonarCloud
- Verify individual `packages/*/coverage/lcov.info` files exist after running tests
- Check that tests were run with coverage in the GitHub Actions workflow
- Ensure `sonar.javascript.lcov.reportPaths` in `sonar-project.properties` matches the coverage file locations

